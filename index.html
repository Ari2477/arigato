<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Arigato</title>
<meta name="color-scheme" content="light dark">
<style>
:root {
  --paper: #fdf8ef;
  --ink: #2c2b27;
  --muted: #7d776f;
  --accent1: #d4732a;
  --accent2: #ba5b2a;
  --glass: rgba(255,255,255,0.35);
}

* {
  box-sizing: border-box;
  font-family: "Patrick Hand", "Comic Neue", "Segoe UI", sans-serif;
}

html, body {
  height: 100%;
  margin: 0;
  background: var(--paper);
  color: var(--ink);
  background-image: radial-gradient(rgba(0,0,0,0.03) 1px, transparent 1px);
  background-size: 8px 8px;
  -webkit-font-smoothing: antialiased;
}

.intro-screen {
  position: fixed;
  inset: 0;
  background: var(--paper);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  flex-direction: column;
  transition: opacity 0.8s ease, transform 1s ease;
  font-family: "Patrick Hand", cursive;
}
.intro-screen.fade-out {
  opacity: 0;
  transform: scale(1.05);
  pointer-events: none;
}
.intro-card {
  text-align: center;
  max-width: 400px;
  background: #fffaf3;
  border: 2px dashed rgba(0,0,0,0.1);
  border-radius: 16px;
  padding: 26px 30px;
  box-shadow: 4px 4px 0 #cbbca3;
  animation: popIn 0.9s ease forwards;
}
.intro-card h1 {
  font-size: 30px;
  color: var(--accent2);
  margin: 0 0 10px 0;
}
.intro-card span {
  color: var(--accent1);
}
.intro-card p {
  font-size: 17px;
  color: var(--muted);
  margin-bottom: 18px;
}
@keyframes popIn {
  from { transform: scale(0.9) rotate(-3deg); opacity: 0; }
  to { transform: scale(1) rotate(0deg); opacity: 1; }
}
  
.app {
  height: 100dvh;
  display: flex;
  flex-direction: column;
  align-items: stretch;
}

.app-header {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px 20px;
  background: var(--paper);
  border-bottom: 2px dashed rgba(0,0,0,0.15);
  box-shadow: 0 3px 10px rgba(0,0,0,0.08);
  border-radius: 0 0 16px 16px;
  position: sticky;
  top: 0;
  z-index: 50;
  transition: background 0.3s ease, transform 0.25s ease;
}

.avatar {
  width: 60px;
  height: 60px;
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #fffdf7;
  border: 2px solid rgba(0,0,0,0.1);
  box-shadow: 2px 2px 0 #cbbca3;
  transition: transform 0.2s ease;
}

.avatar:hover {
  transform: rotate(-4deg) scale(1.05);
}

.hero h1 {
  margin: 0;
  font-size: 28px;
  font-family: "Patrick Hand", cursive;
  color: var(--accent2);
  text-shadow: 1px 1px 0 rgba(0,0,0,0.1);
  letter-spacing: 0.5px;
}

.hero p {
  margin: 0;
  font-size: 15px;
  color: var(--muted);
  font-family: "Comic Neue", sans-serif;
}

.model-tag {
  margin-left: auto;
  background: #fff9ec;
  color: var(--ink);
  font-family: 'Patrick Hand', cursive;
  font-size: 14px;
  border: 2px solid rgba(0,0,0,0.1);
  border-radius: 8px;
  padding: 6px 10px;
  box-shadow: 2px 2px 0 #d7cbb1;
  transition: all 0.2s ease-in-out;
}

.model-tag:hover {
  background: #fff3db;
  transform: rotate(-3deg);
}

.app-header.hidden {
  transform: translateY(-110%);
  opacity: 0;
}

.guide-panel {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(60, 50, 30, 0.3);
  backdrop-filter: blur(6px);
  opacity: 0;
  pointer-events: none;
  transition: opacity .2s ease;
}

.guide-panel.open {
  opacity: 1;
  pointer-events: auto;
}

.guide-card {
  background: #fff8ee;
  border: 2px solid rgba(0,0,0,0.1);
  border-radius: 12px;
  padding: 20px;
  width: 92%;
  max-width: 520px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.15);
  transform: translateY(-16px);
  transition: all .25s ease;
}

.guide-panel.open .guide-card {
  transform: translateY(0);
}

.guide-card h2 {
  margin: 0 0 8px 0;
  color: var(--accent1);
}

.api-row {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}

.api-row input {
  flex: 1;
  padding: 10px;
  border-radius: 8px;
  border: 2px solid rgba(0,0,0,0.1);
  background: #fffefb;
  color: inherit;
  font-size: 15px;
}

.btn {
  padding: 12px 18px;
  border: 2px solid #3b2f2f; 
  border-radius: 10px;
  background: #f9f5e7; 
  color: #3b2f2f;
  font-family: 'Patrick Hand', cursive; 
  font-size: 17px;
  font-weight: 600;
  cursor: pointer;
  display: block; 
  margin-left: 0; 
  margin-right: auto; 
  box-shadow: 2px 2px 0 #cbbca3; 
  transition: all 0.2s ease-in-out;
  width: fit-content; 
}

.btn:hover {
  transform: translate(-2px, -2px);
  box-shadow: 4px 4px 0 #b8a98c;
  background: #fffaf1;
}

.btn:active {
  transform: translate(1px, 1px);
  box-shadow: 1px 1px 0 #b8a98c;
  background: #f3ecda;
}


.btn.primary {
  background: linear-gradient(90deg, var(--accent1), var(--accent2));
  color: #fffaf2;
  border: 1px solid rgba(0,0,0,0.08);
  box-shadow: 0 2px 4px rgba(0,0,0,0.15);
}

.small-muted {
  font-size: 13px;
  color: var(--muted);
  margin-top: 8px;
}

.chat-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 0;
  background: repeating-linear-gradient(
    to bottom,
    #fdf8ef,
    #fdf8ef 26px,
    rgba(0,0,0,0.03) 27px
  );
}

.chat-card {
  flex: 1;
  margin: 8px;
  border-radius: 14px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  background: transparent;
}

.messages {
  flex: 1;
  overflow-y: auto;
  padding: 14px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  overscroll-behavior: contain;
  scroll-behavior: auto;
}

.bubble {
  display: inline-block;
  max-width: 80%;
  min-width: 150px; 
  word-wrap: break-word;
  padding: 10px 14px;
  border-radius: 15px;
  margin: 8px 0;
}

.bubble.ai {
  align-self: flex-start;
  background: rgba(255, 255, 255, 0.7);
  border: 1.5px solid rgba(0,0,0,0.05);
}

.bubble.user {
  align-self: flex-end;
  background: #fff2d6;
  border: 1.5px solid rgba(0,0,0,0.08);
}

.bubble img {
  max-width: 60vw;
  border-radius: 10px;
  margin-top: 8px;
  display: block;
}

.composer {
  display: flex;
  gap: 8px;
  padding: 10px;
  align-items: center;
  border-top: 2px dashed rgba(0,0,0,0.05);
  background: rgba(255,255,255,0.7);
  position: sticky;
  bottom: 0;
  backdrop-filter: blur(4px);
}

.text-input {
  flex: 1;
  min-height: 44px;
  max-height: 160px;
  border-radius: 12px;
  padding: 10px 14px;
  border: 2px solid rgba(0,0,0,0.1);
  background: #fffdf8;
  color: var(--ink);
  font-size: 16px;
  resize: none;
  outline: none;
}

.icon-btn {
  background: transparent;
  border: none;
  color: var(--accent1);
  font-size: 22px;
  padding: 10px;
  border-radius: 10px;
  cursor: pointer;
  transition: transform 0.2s ease;
}

.icon-btn:active {
  transform: scale(0.9);
}

.float-settings {
  position: fixed;
  right: 12px;
  bottom: 86px;
  background: linear-gradient(90deg, var(--accent1), var(--accent2));
  border-radius: 50%;
  padding: 12px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.2);
  z-index: 50;
  color: #fff;
  font-size: 20px;
}

.typing {
  display: inline-flex;
  gap: 6px;
}
.dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--muted);
  opacity: .35;
  animation: dot 1s infinite;
}
.dot:nth-child(2){animation-delay:.12s}
.dot:nth-child(3){animation-delay:.24s}
@keyframes dot {
  0%{opacity:.35}
  50%{opacity:1}
  100%{opacity:.35}
}

@media(max-width:720px){
  .avatar{width:64px;height:64px}
  .hero h1{font-size:18px}
  .bubble{font-size:17px;padding:12px}
  .text-input{font-size:17px}
}

</style>
<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
  <div id="intro" class="intro-screen">
  <div class="intro-card">
    <h1>üëã Welcome to <span>Buddy</span></h1>
    <p>I'm your AI assistant ‚Äî thoughtful, creative, and always ready to chat ‚òï</p>
    <button id="enterBtn" class="btn primary">Start Chat</button>
  </div>
</div>
<div class="app">
  <header class="app-header" id="appHeader">
    <div class="avatar" aria-hidden="true">
      <svg width="48" height="48" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
  <rect x="6" y="6" width="108" height="108" rx="18" fill="#f5eedd" stroke="#cbbca3" stroke-width="3"/>
  
  <rect x="30" y="35" width="60" height="45" rx="10" fill="#fffaf1" stroke="#3b2f2f" stroke-width="3"/>
  
  <circle cx="48" cy="58" r="6" fill="#3b2f2f"/>
  <circle cx="72" cy="58" r="6" fill="#3b2f2f"/>
  
  <rect x="48" y="70" width="24" height="4" rx="2" fill="#3b2f2f"/>
  
  <line x1="60" y1="30" x2="60" y2="20" stroke="#3b2f2f" stroke-width="3" stroke-linecap="round"/>
  <circle cx="60" cy="16" r="3" fill="#3b2f2f"/>
</svg>
    </div>
    <div class="hero">
      <h1>Arigato</h1>
      <p>ARI AI Assistant ‚Äî ‚àû</p>
    </div>
    <div class="model-tag">gpt-4o-mini</div>
  </header>

  <div class="guide-panel" id="guidePanel" aria-hidden="true">
    <div class="guide-card" role="dialog" aria-modal="true" aria-labelledby="guideTitle">
      <h2 id="guideTitle">Setup your OpenRouter API key</h2>
      <p class="small-muted">Your key is stored locally (masked). Change it anytime via Settings.</p>
      <ol>
        <li>Go to <a href="https://openrouter.ai/keys" target="_blank" style="color:var(--accent2)">openrouter.ai/keys</a></li>
        <li>Create a key (starts with <code>sk-or-v1-</code>).</li>
        <li>Paste it below and Save.</li>
      </ol>
      <div class="api-row">
        <input id="apiKey" type="password" placeholder="Paste OpenRouter key (sk-or-v1-...)" />
        <button id="saveKey" class="btn primary">Save</button>
      </div>
      <div id="keyStatus" class="small-muted"></div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button id="closeGuide" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.04)">Close</button>
        <button id="clearKey" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.04)">Remove Key</button>
      </div>
    </div>
  </div>

  <div class="chat-area">
    <div class="chat-card">
      <div class="messages" id="messages" role="log" aria-live="polite"></div>

       <div class="composer">
  <textarea id="textInput" class="text-input" placeholder="Ask something..." rows="1"></textarea>

  <button id="attachBtn" class="icon-btn" title="Attach image">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21.44 11.05l-9.19 9.19a5 5 0 0 1-7.07-7.07l9.2-9.19a3 3 0 0 1 4.24 4.24l-7.07 7.07a1 1 0 0 1-1.41-1.41l6.36-6.36"/>
    </svg>
  </button>

  <button id="sendBtn" class="icon-btn" title="Send">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="22" y1="2" x2="11" y2="13"></line>
      <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
    </svg>
  </button>

  <input id="fileInput" type="file" accept="image/*" style="display:none" />
</div>
    </div>
  </div>

  <button id="openGuideBtn" class="float-settings" title="Settings">‚öôÔ∏è</button>
</div>

<script>
const PROXY = "";
const guidePanel = document.getElementById('guidePanel');
const openGuideBtn = document.getElementById('openGuideBtn');
const closeGuide = document.getElementById('closeGuide');
const saveKeyBtn = document.getElementById('saveKey');
const clearKeyBtn = document.getElementById('clearKey');
const apiInput = document.getElementById('apiKey');
const keyStatus = document.getElementById('keyStatus');
const messagesEl = document.getElementById('messages');
const textInput = document.getElementById('textInput');
const attachBtn = document.getElementById('attachBtn');
const sendBtn = document.getElementById('sendBtn');
const fileInput = document.getElementById('fileInput');

let API_KEY = localStorage.getItem('arigato_key') || "";
let lastScrollTop = 0;

let chatHistory = [];
let memorySummary = JSON.parse(localStorage.getItem("arigato_memory_summary") || "{}");
let userProfile = memorySummary.userProfile || {};

function formatTimestamp(ts){
  const date = new Date(ts);
  return date.toLocaleString("en-US", {hour:"2-digit",minute:"2-digit",hour12:true,month:"short",day:"numeric"});
}
function isNearBottom(){ const el=messagesEl; return (el.scrollHeight-el.scrollTop-el.clientHeight)<140; }
function smartScroll(){ if(isNearBottom()) requestAnimationFrame(()=>messagesEl.scrollTo({top:messagesEl.scrollHeight,behavior:'smooth'})); }
function fileToDataURL(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file);});}

function openGuide(){ guidePanel.classList.add('open'); guidePanel.setAttribute('aria-hidden','false'); if(API_KEY) apiInput.value='‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'; apiInput.focus(); }
function closeGuidePanel(){ guidePanel.classList.remove('open'); guidePanel.setAttribute('aria-hidden','true'); }
openGuideBtn.addEventListener('click', openGuide);
closeGuide.addEventListener('click', closeGuidePanel);
function setKeyStatus(txt,ok=true){ keyStatus.textContent=txt; keyStatus.style.color=ok?'lightgreen':'#ff9aa2'; }
if(API_KEY) setKeyStatus('Key loaded (hidden).'); else setKeyStatus('No key saved.');

saveKeyBtn.addEventListener('click', ()=>{
  const raw=apiInput.value.trim(); 
  if(!raw){ setKeyStatus('Paste your key first.',false); return; }
  if(!raw.startsWith('sk-or-')){ setKeyStatus('Key must start with sk-or-',false); return; }
  API_KEY=raw; localStorage.setItem('arigato_key',API_KEY); apiInput.value='‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'; setKeyStatus('‚úÖ Key saved locally.');
});
clearKeyBtn.addEventListener('click', ()=>{localStorage.removeItem('arigato_key'); API_KEY=''; apiInput.value=''; setKeyStatus('Key removed.',false);});

function clearMemory(){
  memorySummary={};
  chatHistory=[];
  userProfile={};
  localStorage.removeItem("arigato_memory_summary");
  messagesEl.innerHTML="";
  const note=document.createElement("div"); note.className="bubble ai"; note.textContent="üß† Memory cleared. Starting fresh chat."; messagesEl.appendChild(note); smartScroll();
}

function saveMessage(role,text){
  chatHistory.push({role,text,time:Date.now()});
  if(chatHistory.length>50) chatHistory=chatHistory.slice(-50);
  localStorage.setItem("arigato_memory_summary", JSON.stringify({userProfile, chatHistory}));
}

function addUserBubble(text){
  const d=document.createElement('div'); d.className='bubble user';
  d.innerHTML=`<div class="msg-text">${text}</div><hr style="border:none;border-top:1px dashed rgba(0,0,0,0.2);margin:6px 0;" /><div class="msg-time">${formatTimestamp(Date.now())}</div>`;
  messagesEl.appendChild(d); smartScroll();
  saveMessage("user",text); updateUserProfileFromMessage(text);
}

function addAIBubbleTyping(){
  const d=document.createElement('div'); d.className='bubble ai'; d.dataset.typing='1';
  d.innerHTML='<span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>';
  messagesEl.appendChild(d); smartScroll();
}

function replaceTypingWithText(text){
  for(let i=messagesEl.children.length-1;i>=0;i--){
    const ch=messagesEl.children[i];
    if(ch.dataset && ch.dataset.typing==='1'){
      ch.className='bubble ai'; ch.removeAttribute('data-typing');
      ch.innerHTML=`<div class="msg-text">${text}</div><hr style="border:none;border-top:1px dashed rgba(0,0,0,0.2);margin:6px 0;" /><div class="msg-time">${formatTimestamp(Date.now())}</div>`;
      smartScroll(); saveMessage("ai",text); return;
    }
  }
  const d=document.createElement('div'); d.className='bubble ai';
  d.innerHTML=`<div class="msg-text">${text}</div><hr style="border:none;border-top:1px dashed rgba(0,0,0,0.2);margin:6px 0;" /><div class="msg-time">${formatTimestamp(Date.now())}</div>`;
  messagesEl.appendChild(d); smartScroll(); saveMessage("ai",text);
}

function updateUserProfileFromMessage(text){
  const nameMatch=text.match(/i am (\w+)/i); if(nameMatch) userProfile.name=nameMatch[1];
  const roleMatch=text.match(/i am your (.+)/i); if(roleMatch) userProfile.role=roleMatch[1];
}

function shouldUseEmoji(userText){
  const seriousPatterns = /\?|what|when|where|who|how|why/i;
  return !seriousPatterns.test(userText);
}

function buildOpenRouterMessages(text,imageData){
  const content=[]; if(text) content.push({type:"text",text}); if(imageData) content.push({type:"image_url",image_url:imageData});
  const recentMessages = chatHistory.slice(-12).map(msg=>({role: msg.role==="ai"?"assistant":"user", content:[{type:"text", text:`[${formatTimestamp(msg.time)}] ${msg.text}` }]}));
  const messages=[];
  messages.push({
    role:"system",
    content:[{type:"text",text:`You are Arigato, a playful assistant. Remember user's name & role. Respond casually to friendly messages with emojis. Do NOT use emojis for serious questions.`}]
  });
  if(memorySummary.chatHistory) messages.push(...recentMessages);
  messages.push({role:"user", content});
  messages.emojiAllowed = shouldUseEmoji(text);
  return messages;
}

async function sendToOpenRouter(text="", imageData=null){
  if(!API_KEY){replaceTypingWithText("‚ö†Ô∏è Please save your OpenRouter API key first."); return;}
  try{
    const messages=buildOpenRouterMessages(text,imageData);
    const resp=await fetch((PROXY||"")+"https://openrouter.ai/api/v1/chat/completions", {method:"POST", headers:{"Authorization":`Bearer ${API_KEY}`,"Content-Type":"application/json"}, body:JSON.stringify({model:"gpt-4o-mini",messages})});
    const data=await resp.json(); if(!resp.ok){replaceTypingWithText("‚ö†Ô∏è API error"); return;}
    let answer=""; const choice=data.choices?.[0];
    if(choice?.message?.content){ const c=choice.message.content; if(Array.isArray(c)) c.forEach(p=>{if(p.type==="text"&&p.text) answer+=p.text;}); else if(typeof c==="string") answer=c; else if(c.text) answer=c.text;}
    if(!answer) answer="(no reply)";

    if(userProfile.name && /who am i/i.test(text)) answer=`You're my ${userProfile.role||'special user'} üòè`;

    if(messages.emojiAllowed && !/who am i|what|how|why/i.test(text)) answer += " üòè";

    replaceTypingWithText(answer);
  } catch(err){replaceTypingWithText("‚ö†Ô∏è Request failed: "+(err.message||err));}
}

attachBtn.addEventListener('click', ()=>fileInput.click());
fileInput.addEventListener('change', async(e)=>{
  const f = e.target.files && e.target.files[0]; if(!f) return;
  const dataUrl = await fileToDataURL(f);
  const userPrompt = prompt("Enter a prompt for this image:");
  if(!userPrompt) return alert("Upload canceled ‚Äî no prompt entered.");

  addUserBubble(userPrompt);

  const d = document.createElement('div');
  d.className = 'bubble user';
  d.textContent = 'üì∑ Image attached';
  const img = document.createElement('img');
  img.src = dataUrl; img.alt = 'attached image';
  d.appendChild(img); messagesEl.appendChild(d); smartScroll();

  addAIBubbleTyping();
  await sendToOpenRouter(userPrompt, dataUrl);
});

sendBtn.addEventListener('click', async()=>{
  const text=textInput.value.trim(); if(!text) return; addUserBubble(text); textInput.value=''; textInput.style.height='auto'; addAIBubbleTyping(); await sendToOpenRouter(text,null);
});
textInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendBtn.click();}});
textInput.addEventListener('input',()=>{textInput.style.height='auto'; textInput.style.height=Math.min(textInput.scrollHeight,160)+'px';});

messagesEl.addEventListener('scroll', ()=>{
  const st=messagesEl.scrollTop;
  const appHeader=document.getElementById('appHeader');
  if(appHeader){
    if(st>lastScrollTop+12){ appHeader.style.transform='translateY(-110%)'; appHeader.style.opacity='0'; }
    else if(st<lastScrollTop-12){ appHeader.style.transform=''; appHeader.style.opacity=''; }
  }
  lastScrollTop = st<=0?0:st;
});

window.addEventListener('load', ()=>{
  messagesEl.innerHTML="";
  const note=document.createElement("div"); note.className="bubble ai";
  if(userProfile.name) note.textContent=`üß† I remember you, ${userProfile.name}!`; 
  else note.textContent="üí¨ Start a new chat session.";
  messagesEl.appendChild(note); smartScroll();
  setTimeout(()=>textInput.focus(),200);
  chatHistory=[];
});

  const introScreen = document.getElementById("intro");
const enterBtn = document.getElementById("enterBtn");
enterBtn.addEventListener("click", () => {
  introScreen.classList.add("fade-out");
  setTimeout(() => introScreen.remove(), 900);
});
</script>
</body>
</html>
